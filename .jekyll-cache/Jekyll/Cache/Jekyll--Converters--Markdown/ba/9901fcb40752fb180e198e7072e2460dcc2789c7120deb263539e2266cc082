I"ï<h2 id="å®ç°å¹¶è¡Œæ¢¯å½¢æ•°å€¼ç§¯åˆ†çš„mpiç®—æ³•">å®ç°å¹¶è¡Œæ¢¯å½¢æ•°å€¼ç§¯åˆ†çš„MPIç®—æ³•</h2>

<p>ä¸‹ä¸ºå•èŠ‚ç‚¹æ±‚è§£$\int_{a}^bf(x)dx$çš„å‡½æ•°ï¼Œå…¶ä¸­<code class="highlighter-rouge">e</code>æ˜¯é€¼è¿‘çš„æ­¥é•¿ã€‚ç”±äºå•è´¦å·çš„è¿è¡Œæ—¶é—´æƒé™æ˜¯ä¸€ä¸ªå°æ—¶ï¼Œè¿™é‡Œæˆ‘ç»è¿‡è°ƒå‚ï¼Œå–<code class="highlighter-rouge">e=1e-2</code>æ˜¯å¯ä»¥åœ¨æ—¶é™å†…è®¡ç®—å®Œæ¯•çš„ï¼ˆçº¦å››ååˆ†é’Ÿï¼‰ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lf</span> <span class="nf">ask</span><span class="p">(</span><span class="n">lf</span> <span class="n">a</span><span class="p">,</span> <span class="n">lf</span> <span class="n">b</span><span class="p">,</span> <span class="n">lf</span> <span class="n">f</span><span class="p">(</span><span class="n">lf</span> <span class="n">x</span><span class="p">),</span> <span class="n">lf</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lf</span> <span class="n">ans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fa</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">lf</span> <span class="n">fb</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span> <span class="o">+=</span> <span class="n">e</span><span class="p">);</span>
		<span class="n">ans</span> <span class="o">+=</span> <span class="n">fa</span> <span class="o">+</span> <span class="n">fb</span><span class="p">;</span>
		<span class="n">fa</span> <span class="o">=</span> <span class="n">fb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ans</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™é‡Œæœ‰å‡ å¤„ä¼˜åŒ–ç»†èŠ‚ï¼Œé€šè¿‡è°ƒæ•´æ±‚å€¼å…³ç³»ï¼Œä½¿å¾—æ¯ä¸ªç‚¹å¤„çš„å‡½æ•°å€¼ä¸è¢«é‡å¤è®¡ç®—ï¼›åŒæ—¶æŠŠæ¢¯å½¢çš„é«˜ç§»åŠ¨åˆ°å¾ªç¯å¤–é¢ï¼Œå‡å°‘è®¡ç®—æ¬¡æ•°ã€‚</p>

<p>å½“ç„¶ï¼Œç”±äºè¿™é‡Œçš„æ­¥é•¿å…¶å®åªæœ‰ç™¾åˆ†ä¹‹ä¸€ï¼Œå› æ­¤æœ€åæ±‚å‡ºæ¥çš„ç§¯åˆ†å…¶å®ç²¾åº¦ä¸æ€ä¹ˆé«˜ï¼Œå’Œè‡ªå·±æ‰‹ç®—çš„ç»“æœç›¸æ¯”åªèƒ½ä¿è¯äº”å…­ä½çš„æœ‰æ•ˆä½æ•°ã€‚</p>

<h3 id="ç”¨mpiçš„ç‚¹å¯¹ç‚¹é€šä¿¡å‡½æ•°å®Œæˆæ¢¯å½¢æ•°å€¼ç§¯åˆ†çš„å¹¶è¡Œç®—æ³•">ç”¨MPIçš„ç‚¹å¯¹ç‚¹é€šä¿¡å‡½æ•°å®Œæˆæ¢¯å½¢æ•°å€¼ç§¯åˆ†çš„å¹¶è¡Œç®—æ³•</h3>

<p>å„è¿›ç¨‹å°†å„è‡ªè®¡ç®—çš„ç»“æœ<code class="highlighter-rouge">myAns</code>å‘é€åˆ°0å·è¿›ç¨‹å¹¶æ±‚å’Œ<code class="highlighter-rouge">ans</code>ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numThreads</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">MPI_Recv</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">myAns</span><span class="p">,</span>
				<span class="mi">1</span><span class="p">,</span>
				<span class="n">MPI_DOUBLE</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span>
				<span class="n">MPI_COMM_WORLD</span><span class="p">,</span>
				<span class="n">MPI_STATUES_IGNORE</span><span class="p">);</span>
			<span class="n">ans</span> <span class="o">+=</span> <span class="n">myAns</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="nf">MPI_Send</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">myAns</span><span class="p">,</span>
			<span class="mi">1</span><span class="p">,</span>
			<span class="n">MPI_DOUBLE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="ç”¨mpiçš„é›†åˆé€šä¿¡å‡½æ•°å®Œæˆæ¢¯å½¢æ•°å€¼ç§¯åˆ†çš„å¹¶è¡Œç®—æ³•">ç”¨MPIçš„é›†åˆé€šä¿¡å‡½æ•°å®Œæˆæ¢¯å½¢æ•°å€¼ç§¯åˆ†çš„å¹¶è¡Œç®—æ³•</h3>

<p>ä½¿ç”¨<code class="highlighter-rouge">Reduce</code>æ“ä½œå°†å„çº¿ç¨‹çš„ç»“æœ<code class="highlighter-rouge">myAns</code>å½’çº¦åˆ°0å·è¿›ç¨‹çš„<code class="highlighter-rouge">ans</code>ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">MPI_Reduce</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">myAns</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">ans</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span>
		<span class="n">MPI_DOUBLE</span><span class="p">,</span>
		<span class="n">MPI_SUM</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="å°†ä¸Šé¢çš„ç®—æ³•å¯¹ç‘•ç§¯åˆ†æ‰©å±•">å°†ä¸Šé¢çš„ç®—æ³•å¯¹ç‘•ç§¯åˆ†æ‰©å±•</h3>

<p>å‡è®¾è¢«ç§¯å‡½æ•°f(x)å¯èƒ½æ˜¯æ— ç•Œå‡½æ•°ï¼Œç§¯åˆ†åŒºé—´ä¹Ÿå¾ˆå¤§ï¼Œå¦‚</p>

<ul>
  <li>f(x)=exp(bx)/sqrt(1+exp(cx)), 0&lt;x&lt;=L;</li>
  <li>è¿™æ—¶ç§¯åˆ†åŒºé—´[0,L]åˆ’åˆ†ä¸èƒ½æ˜¯ç­‰é•¿çš„ï¼Œæ¯ä¸ªä»»åŠ¡çš„å°åŒºé—´éœ€è¦ä¼ é€’ï¼Œå¹¶ä¸”å‚æ•°bï¼Œcï¼ŒLä¹Ÿéœ€è¦ä¼ é€’ã€‚</li>
</ul>

<p>è¿™é‡Œé€‰æ‹©ä½¿ç”¨è‡ªé€‚åº”è¾›æ™®æ£®æ–¹æ³•æ±‚è§£ç‘•ç§¯åˆ†ï¼Œæ ¹æ®<a href="http://www2.math.umd.edu/~mariakc/teaching/adaptive.pdf">è¿™ç¯‡è®ºæ–‡</a>ï¼Œè®ºè¯äº†åŠ ä¸€ä¸ªåäº”åˆ†ä¹‹ä¸€çš„åç§»æ”¶æ•›ä¼šæ¯”è¾ƒå¿«ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lf</span> <span class="nf">f</span><span class="p">(</span><span class="n">lf</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">lf</span> <span class="nf">simpson</span><span class="p">(</span><span class="n">lf</span> <span class="n">a</span><span class="p">,</span> <span class="n">lf</span> <span class="n">b</span><span class="p">,</span> <span class="n">lf</span> <span class="n">f</span><span class="p">(</span><span class="n">lf</span> <span class="n">x</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">EPS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">f</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">f</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">lf</span> <span class="nf">ask</span><span class="p">(</span><span class="n">lf</span> <span class="n">a</span><span class="p">,</span> <span class="n">lf</span> <span class="n">b</span><span class="p">,</span> <span class="n">lf</span> <span class="n">f</span><span class="p">(</span><span class="n">lf</span> <span class="n">x</span><span class="p">),</span> <span class="n">lf</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="n">EPS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">simpson</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="n">lf</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">simpson</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">R</span> <span class="o">=</span> <span class="n">simpson</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="n">R</span> <span class="o">-</span> <span class="n">simpson</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="o">/</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fabs</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">e</span> <span class="o">?</span> <span class="n">L</span> <span class="o">+</span> <span class="n">R</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">:</span> <span class="n">ask</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">ask</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸è¿‡ï¼Œåœ¨å¯¹è€å¸ˆç»™çš„è¿™ä¸ªå‡½æ•°ï¼ˆå–<code class="highlighter-rouge">b = c = 1</code>ï¼‰è¿›è¡Œç‘•ç§¯åˆ†æ±‚è§£çš„æ—¶å€™ï¼Œå‘ç°ç§¯åˆ†ä¸Šé™è¾¾åˆ°$2^{10}$çš„æ—¶å€™ï¼Œç»“æœå·²ç»è¶…è¿‡äº†<code class="highlighter-rouge">double</code>ç±»å‹çš„è¡¨ç¤ºèŒƒå›´ï¼Œå› æ­¤è¿™æ®µä»£ç ä»…ç”¨æ¥éªŒè¯ç‘•ç§¯åˆ†æ±‚è§£çš„æ­£ç¡®æ€§ï¼Œä¸‹é¢è¿›è¡Œå¤šæ ¸æµ‹é€Ÿçš„ä»£ç ä»ç„¶ä½¿ç”¨çš„æ˜¯æ¢¯å½¢ç§¯åˆ†æ³•ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">time </span>mpiexec <span class="nt">-n</span> 1 ./integral 9
3022859422404135022056366724809190601572944773201862114369138391962853640177743445854646916709852400063199838208.000000 with 1 proces, problem size 512.
real    0m0.058s
user    0m0.000s
sys     0m0.063s
<span class="nv">$ </span><span class="nb">time </span>mpiexec <span class="nt">-n</span> 1 ./integral 10
<span class="nt">-nan</span> with 1 proces, problem size 1024.
real    0m0.058s
user    0m0.000s
sys     0m0.047s
</code></pre></div></div>

<h3 id="å¡«è¡¨">å¡«è¡¨</h3>

<h4 id="è¿è¡Œæ—¶é—´tå•ä½s">è¿è¡Œæ—¶é—´Tï¼ˆå•ä½sï¼‰</h4>

<p>è¯¦è§ä¸‹é¢çš„è¾“å‡ºæ–‡ä»¶éƒ¨åˆ†ã€‚</p>

<table>
  <thead>
    <tr>
      <th>è¿›ç¨‹æ•°\é—®é¢˜è§„æ¨¡</th>
      <th>$2^{14}$</th>
      <th>$2^{18}$</th>
      <th>$2^{22}$</th>
      <th>$2^{26}$</th>
      <th>$2^{30}$</th>
      <th>$2^{31}$</th>
      <th>$2^{32}$</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>0.424</td>
      <td>0.513</td>
      <td>1.928</td>
      <td>23.536</td>
      <td>357.396</td>
      <td>706.644</td>
      <td>1441.164</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.426</td>
      <td>0.553</td>
      <td>1.403</td>
      <td>11.794</td>
      <td>182.182</td>
      <td>354.155</td>
      <td>706.369</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.466</td>
      <td>0.542</td>
      <td>1.019</td>
      <td>6.230</td>
      <td>92.010</td>
      <td>179.062</td>
      <td>353.818</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.543</td>
      <td>0.487</td>
      <td>0.716</td>
      <td>3.667</td>
      <td>46.014</td>
      <td>92.823</td>
      <td>177.530</td>
    </tr>
    <tr>
      <td>16</td>
      <td>0.541</td>
      <td>0.576</td>
      <td>0.719</td>
      <td>2.177</td>
      <td>23.253</td>
      <td>46.102</td>
      <td>93.670</td>
    </tr>
    <tr>
      <td>32</td>
      <td>0.898</td>
      <td>0.747</td>
      <td>0.826</td>
      <td>1.663</td>
      <td>12.633</td>
      <td>23.169</td>
      <td>45.404</td>
    </tr>
    <tr>
      <td>64</td>
      <td>1.464</td>
      <td>1.067</td>
      <td>1.116</td>
      <td>1.638</td>
      <td>6.812</td>
      <td>12.324</td>
      <td>23.790</td>
    </tr>
    <tr>
      <td>128</td>
      <td>1.110</td>
      <td>1.076</td>
      <td>1.176</td>
      <td>1.416</td>
      <td>4.105</td>
      <td>6.952</td>
      <td>12.525</td>
    </tr>
    <tr>
      <td>256</td>
      <td>1.534</td>
      <td>1.188</td>
      <td>1.196</td>
      <td>1.319</td>
      <td>2.848</td>
      <td>4.110</td>
      <td>6.936</td>
    </tr>
    <tr>
      <td>512</td>
      <td>1.802</td>
      <td>1.704</td>
      <td>1.695</td>
      <td>1.754</td>
      <td>2.210</td>
      <td>2.626</td>
      <td>3.478</td>
    </tr>
  </tbody>
</table>

<p>å¯ä»¥çœ‹åˆ°ï¼š</p>

<ul>
  <li>éšç€é—®é¢˜è§„æ¨¡å¢åŠ ï¼ŒåŒè¿›ç¨‹æ•°ä¸‹è¿è¡Œæ—¶é—´ä¸æ–­å¢åŠ </li>
  <li>é—®é¢˜è§„æ¨¡æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œè¿›ç¨‹è¶Šå¤šå¹¶è¡Œæ—¶é—´å¼€é”€è¶Šå¤§</li>
  <li>é—®é¢˜è§„æ¨¡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œè¿è¡Œæ—¶é—´å‡å°‘</li>
</ul>

<h4 id="åŠ é€Ÿæ¯”s">åŠ é€Ÿæ¯”S</h4>

<p>åŠ é€Ÿæ¯”S=åŒç­‰è§„æ¨¡ä¸‹çš„ä¸²è¡Œæ—¶é—´/å¹¶è¡Œæ—¶é—´ã€‚</p>

<table>
  <thead>
    <tr>
      <th>è¿›ç¨‹æ•°\é—®é¢˜è§„æ¨¡</th>
      <th>$2^{14}$</th>
      <th>$2^{18}$</th>
      <th>$2^{22}$</th>
      <th>$2^{26}$</th>
      <th>$2^{30}$</th>
      <th>$2^{31}$</th>
      <th>$2^{32}$</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1.00</td>
      <td>0.93</td>
      <td>1.37</td>
      <td>2.00</td>
      <td>1.96</td>
      <td>2.00</td>
      <td>2.04</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.91</td>
      <td>0.95</td>
      <td>1.89</td>
      <td>3.78</td>
      <td>3.88</td>
      <td>3.94</td>
      <td>4.07</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.78</td>
      <td>1.05</td>
      <td>2.69</td>
      <td>6.41</td>
      <td>7.77</td>
      <td>7.61</td>
      <td>8.12</td>
    </tr>
    <tr>
      <td>16</td>
      <td>0.78</td>
      <td>0.89</td>
      <td>2.68</td>
      <td>10.81</td>
      <td>15.37</td>
      <td>15.33</td>
      <td>15.39</td>
    </tr>
    <tr>
      <td>32</td>
      <td>0.47</td>
      <td>0.69</td>
      <td>2.33</td>
      <td>14.15</td>
      <td>28.29</td>
      <td>30.50</td>
      <td>31.74</td>
    </tr>
    <tr>
      <td>64</td>
      <td>0.29</td>
      <td>0.48</td>
      <td>1.72</td>
      <td>14.38</td>
      <td>52.47</td>
      <td>57.34</td>
      <td>60.58</td>
    </tr>
    <tr>
      <td>128</td>
      <td>0.38</td>
      <td>0.48</td>
      <td>1.63</td>
      <td>16.62</td>
      <td>87.06</td>
      <td>101.65</td>
      <td>115.06</td>
    </tr>
    <tr>
      <td>256</td>
      <td>0.28</td>
      <td>0.43</td>
      <td>1.61</td>
      <td>17.84</td>
      <td>125.49</td>
      <td>171.93</td>
      <td>207.78</td>
    </tr>
    <tr>
      <td>512</td>
      <td>0.24</td>
      <td>0.30</td>
      <td>1.14</td>
      <td>13.42</td>
      <td>161.71</td>
      <td>269.10</td>
      <td>414.37</td>
    </tr>
  </tbody>
</table>

<p>å¯ä»¥çœ‹åˆ°ï¼š</p>

<ul>
  <li>éšç€é—®é¢˜è§„æ¨¡å¢åŠ ï¼ŒåŒè¿›ç¨‹æ•°ä¸‹åŠ é€Ÿæ¯”ä¸æ–­å¢åŠ </li>
  <li>éšç€è¿›ç¨‹æ•°å¢åŠ ï¼ŒåŒé—®é¢˜è§„æ¨¡ä¸‹åŠ é€Ÿæ¯”ä¸æ–­å‡å°‘</li>
</ul>

<h4 id="æ•ˆç‡e">æ•ˆç‡E</h4>

<p>è¿è¡Œæ•ˆç‡E=åŠ é€Ÿæ¯”S/å¹¶è¡Œçº¿ç¨‹æ•°ã€‚</p>

<table>
  <thead>
    <tr>
      <th>è¿›ç¨‹æ•°\é—®é¢˜è§„æ¨¡</th>
      <th>$2^{14}$</th>
      <th>$2^{18}$</th>
      <th>$2^{22}$</th>
      <th>$2^{26}$</th>
      <th>$2^{30}$</th>
      <th>$2^{31}$</th>
      <th>$2^{32}$</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>1.00</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.50</td>
      <td>0.93</td>
      <td>0.68</td>
      <td>1.00</td>
      <td>0.98</td>
      <td>1.00</td>
      <td>1.02</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.23</td>
      <td>0.24</td>
      <td>0.47</td>
      <td>0.95</td>
      <td>0.97</td>
      <td>0.99</td>
      <td>1.02</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.10</td>
      <td>0.13</td>
      <td>0.34</td>
      <td>0.81</td>
      <td>0.97</td>
      <td>0.95</td>
      <td>1.02</td>
    </tr>
    <tr>
      <td>16</td>
      <td>0.05</td>
      <td>0.06</td>
      <td>0.17</td>
      <td>0.68</td>
      <td>0.96</td>
      <td>0.96</td>
      <td>0.96</td>
    </tr>
    <tr>
      <td>32</td>
      <td>0.01</td>
      <td>0.02</td>
      <td>0.07</td>
      <td>0.44</td>
      <td>0.88</td>
      <td>0.95</td>
      <td>0.99</td>
    </tr>
    <tr>
      <td>64</td>
      <td>0.005</td>
      <td>0.008</td>
      <td>0.03</td>
      <td>0.22</td>
      <td>0.82</td>
      <td>0.90</td>
      <td>0.95</td>
    </tr>
    <tr>
      <td>128</td>
      <td>0.003</td>
      <td>0.004</td>
      <td>0.01</td>
      <td>0.13</td>
      <td>0.68</td>
      <td>0.79</td>
      <td>0.90</td>
    </tr>
    <tr>
      <td>256</td>
      <td>0.001</td>
      <td>0.002</td>
      <td>0.006</td>
      <td>0.07</td>
      <td>0.49</td>
      <td>0.67</td>
      <td>0.81</td>
    </tr>
    <tr>
      <td>512</td>
      <td>0.0005</td>
      <td>0.0006</td>
      <td>0.002</td>
      <td>0.03</td>
      <td>0.32</td>
      <td>0.53</td>
      <td>0.81</td>
    </tr>
  </tbody>
</table>

<p>å¯ä»¥çœ‹åˆ°ï¼š</p>

<ul>
  <li>éšç€é—®é¢˜è§„æ¨¡å¢åŠ ï¼ŒåŒè¿›ç¨‹æ•°ä¸‹æ•ˆç‡ä¸æ–­å¢åŠ </li>
  <li>éšç€è¿›ç¨‹æ•°å¢åŠ ï¼ŒåŒé—®é¢˜è§„æ¨¡ä¸‹æ•ˆç‡ä¸æ–­å‡å°‘</li>
</ul>

<p>æ­¤å¤–ï¼Œéƒ¨åˆ†æ•°æ®å‡ºç°äº†æ•ˆç‡ç•¥å¤§äº1çš„æƒ…å†µï¼Œå¯èƒ½æ˜¯ç”±äºç³»ç»Ÿè¿è¡Œæ—¶çš„â€œæŠ–åŠ¨â€é€ æˆçš„ï¼Œä»ç„¶åœ¨è¯¯å·®èŒƒå›´å†…ï¼Œç¬¦åˆå¸¸è¯†ã€‚</p>

<h3 id="æºä»£ç integralc">æºä»£ç <code class="highlighter-rouge">integral.c</code></h3>

<p>å»æ‰<code class="highlighter-rouge">#define WK_SIMPSON</code>å‰çš„æ³¨é‡Šç¬¦å·å³å¯é€‰ç”¨è‡ªé€‚åº”è¾›æ™®æ£®å…¬å¼æ±‚è§£ç‘•ç§¯åˆ†ã€‚</p>

<p>å»æ‰<code class="highlighter-rouge">#define WK_P2P</code>å‰çš„æ³¨é‡Šç¬¦å·å³å¯é€‰ç”¨ç‚¹å¯¹ç‚¹é€šä¿¡ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//#define WK_SIMPSON</span>
<span class="c1">//#define WK_P2P</span>
<span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;math.h&gt;
#include &lt;mpi.h&gt;
</span><span class="k">typedef</span> <span class="kt">double</span> <span class="n">lf</span><span class="p">;</span>
<span class="k">const</span> <span class="n">lf</span> <span class="n">EPS</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">;</span>
<span class="cp">#ifdef WK_SIMPSON
</span><span class="n">lf</span> <span class="nf">f</span><span class="p">(</span><span class="n">lf</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">lf</span> <span class="nf">simpson</span><span class="p">(</span><span class="n">lf</span> <span class="n">a</span><span class="p">,</span> <span class="n">lf</span> <span class="n">b</span><span class="p">,</span> <span class="n">lf</span> <span class="n">f</span><span class="p">(</span><span class="n">lf</span> <span class="n">x</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">EPS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">f</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">f</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">lf</span> <span class="nf">ask</span><span class="p">(</span><span class="n">lf</span> <span class="n">a</span><span class="p">,</span> <span class="n">lf</span> <span class="n">b</span><span class="p">,</span> <span class="n">lf</span> <span class="n">f</span><span class="p">(</span><span class="n">lf</span> <span class="n">x</span><span class="p">),</span> <span class="n">lf</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="n">EPS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">simpson</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="n">lf</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">simpson</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">R</span> <span class="o">=</span> <span class="n">simpson</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="n">R</span> <span class="o">-</span> <span class="n">simpson</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="o">/</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fabs</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">e</span> <span class="o">?</span> <span class="n">L</span> <span class="o">+</span> <span class="n">R</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">:</span> <span class="n">ask</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">ask</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else
</span><span class="n">lf</span> <span class="nf">f</span><span class="p">(</span><span class="n">lf</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">lf</span> <span class="nf">ask</span><span class="p">(</span><span class="n">lf</span> <span class="n">a</span><span class="p">,</span> <span class="n">lf</span> <span class="n">b</span><span class="p">,</span> <span class="n">lf</span> <span class="n">f</span><span class="p">(</span><span class="n">lf</span> <span class="n">x</span><span class="p">),</span> <span class="n">lf</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lf</span> <span class="n">ans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fa</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">lf</span> <span class="n">fb</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span> <span class="o">+=</span> <span class="n">e</span><span class="p">);</span>
		<span class="n">ans</span> <span class="o">+=</span> <span class="n">fa</span> <span class="o">+</span> <span class="n">fb</span><span class="p">;</span>
		<span class="n">fa</span> <span class="o">=</span> <span class="n">fb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ans</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">numThreads</span><span class="p">;</span>
	<span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">numThreads</span><span class="p">);</span>
	<span class="n">lf</span> <span class="n">n</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
	   <span class="n">len</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">numThreads</span><span class="p">,</span>
	   <span class="n">myL</span> <span class="o">=</span> <span class="n">id</span> <span class="o">*</span> <span class="n">len</span><span class="p">,</span>
	   <span class="n">myAns</span> <span class="o">=</span> <span class="n">ask</span><span class="p">(</span><span class="n">myL</span><span class="p">,</span> <span class="n">myL</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">),</span>
	   <span class="n">ans</span> <span class="o">=</span> <span class="n">myAns</span><span class="p">;</span>
<span class="cp">#ifdef WK_P2P
</span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numThreads</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">MPI_Recv</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">myAns</span><span class="p">,</span>
				<span class="mi">1</span><span class="p">,</span>
				<span class="n">MPI_DOUBLE</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span>
				<span class="n">MPI_COMM_WORLD</span><span class="p">,</span>
				<span class="n">MPI_STATUES_IGNORE</span><span class="p">);</span>
			<span class="n">ans</span> <span class="o">+=</span> <span class="n">myAns</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">MPI_Send</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">myAns</span><span class="p">,</span>
			<span class="mi">1</span><span class="p">,</span>
			<span class="n">MPI_DOUBLE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="cp">#else
</span>	<span class="n">MPI_Reduce</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">myAns</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">ans</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span>
		<span class="n">MPI_DOUBLE</span><span class="p">,</span>
		<span class="n">MPI_SUM</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="cp">#endif
</span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"%f with %d proces, problem size %.0f."</span><span class="p">,</span> <span class="n">ans</span><span class="p">,</span> <span class="n">numThreads</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="ä½œä¸šè„šæœ¬integralpbs">ä½œä¸šè„šæœ¬<code class="highlighter-rouge">integral.pbs</code></h3>

<p>å¯¹äºä¸åŒçš„æ ¸æ•°éœ€è¦ä¸åŒçš„ä½œä¸šè„šæœ¬ï¼Œè¿™é‡Œåªç»™å‡º512æ ¸å¯¹åº”çš„ä½œä¸šè„šæœ¬<code class="highlighter-rouge">integral.pbs</code>ã€‚</p>

<p>è¿™é‡Œå­¦ä¹ äº†ä¸€ä¸‹ä»PBSçš„æœ¬åœ°å˜é‡ä¸­è·å¾—mpiexecçš„è¿è¡Œé…ç½®çš„æ–¹æ³•ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#PBS -N integral</span>
<span class="c">#PBS -l nodes=16:ppn=32</span>
<span class="c">#PBS -j oe</span>

<span class="nb">source</span> /public/software/profile.d/mpi_openmpi-intel-2.1.2.sh
mpicc integral.c <span class="nt">-o</span> integral <span class="nt">-std</span><span class="o">=</span>c11 <span class="nt">-lm</span>
<span class="k">for </span>logN <span class="k">in </span>14 18 22 26 30 31 32
<span class="k">do
</span><span class="nb">time </span>mpiexec <span class="nt">-machinefile</span> <span class="nv">$PBS_NODEFILE</span> ./integral <span class="nv">$logN</span>
<span class="k">done</span>
</code></pre></div></div>

<h3 id="è¾“å‡ºæ–‡ä»¶integralo1761">è¾“å‡ºæ–‡ä»¶<code class="highlighter-rouge">integral.o1761</code></h3>

<p>å¯¹äºä¸åŒçš„æ ¸æ•°éœ€è¦ä¸åŒçš„è¾“å‡ºæ–‡ä»¶ï¼Œè¿™é‡Œåªç»™å‡º512æ ¸å¯¹åº”è¾“å‡ºæ–‡ä»¶<code class="highlighter-rouge">integral.o1761</code>ã€‚</p>

<p>å…¶ä»–æ ¸æ•°å¯¹åº”çš„è¾“å‡ºæ–‡ä»¶è§é™„ä»¶</p>

<ul>
  <li><code class="highlighter-rouge">integral.o1795</code>å¯¹åº”256æ ¸ï¼ˆ<code class="highlighter-rouge">nodes=8:ppn=32</code>ï¼‰</li>
  <li><code class="highlighter-rouge">integral.o1796</code>å¯¹åº”128æ ¸ï¼ˆ<code class="highlighter-rouge">nodes=4:ppn=32</code>ï¼‰</li>
  <li><code class="highlighter-rouge">integral.o1797</code>å¯¹åº”64æ ¸ï¼ˆ<code class="highlighter-rouge">nodes=2:ppn=32</code>ï¼‰</li>
  <li><code class="highlighter-rouge">integral.o1798</code>å¯¹åº”32æ ¸ï¼ˆ<code class="highlighter-rouge">nodes=1:ppn=32</code>ï¼‰</li>
  <li><code class="highlighter-rouge">integral.o1799</code>å¯¹åº”16æ ¸ï¼ˆ<code class="highlighter-rouge">nodes=1:ppn=16</code>ï¼‰</li>
  <li><code class="highlighter-rouge">integral.o1800</code>å¯¹åº”8æ ¸ï¼ˆ<code class="highlighter-rouge">nodes=1:ppn=8</code>ï¼‰</li>
  <li><code class="highlighter-rouge">integral.o1801</code>å¯¹åº”4æ ¸ï¼ˆ<code class="highlighter-rouge">nodes=1:ppn=4</code>ï¼‰</li>
  <li><code class="highlighter-rouge">integral.o1802</code>å¯¹åº”2æ ¸ï¼ˆ<code class="highlighter-rouge">nodes=1:ppn=2</code>ï¼‰</li>
  <li><code class="highlighter-rouge">integral.o1803</code>å¯¹åº”1æ ¸ï¼ˆ<code class="highlighter-rouge">nodes=1:ppn=1</code>ï¼‰</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>134218391.043055 with 512 proces, problem size 16384.
real	0m1.802s
user	0m2.328s
sys	0m6.054s
34359872522.271759 with 512 proces, problem size 262144.
real	0m1.704s
user	0m2.188s
sys	0m5.706s
8796101094338.814453 with 512 proces, problem size 4194304.
real	0m1.695s
user	0m2.281s
sys	0m5.844s
2251800146489160.500000 with 512 proces, problem size 67108864.
real	0m1.754s
user	0m4.053s
sys	0m5.900s
576461292861516288.000000 with 512 proces, problem size 1073741824.
real	0m2.210s
user	0m20.316s
sys	0m5.308s
2305845201815247872.000000 with 512 proces, problem size 2147483648.
real	0m2.626s
user	0m36.019s
sys	0m4.861s
9223215905289959424.000000 with 512 proces, problem size 4294967296.
real	0m3.478s
user	0m59.168s
sys	0m5.120s
</code></pre></div></div>

<h2 id="å®Œæˆæ­£åˆ™é‡‡æ ·æ’åºpsrsçš„mpiç®—æ³•">å®Œæˆæ­£åˆ™é‡‡æ ·æ’åºPSRSçš„MPIç®—æ³•</h2>

<p>æ’åºæ–‡ä»¶æ”¾åœ¨é›†ç¾¤çš„shared_dirç›®å½•ä¸‹ï¼Œæ–‡ä»¶åä¸ºï¼špsrs_dataã€‚æ–‡ä»¶é‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼ï¼šå¤´å…«ä¸ªå­—èŠ‚ä¸ºæ’åºæ•°æ®ä¸ªæ•°(long int), æ¯ä¸ªæ•°æ®ä¸º8ä¸ªå­—èŠ‚ã€‚</p>

<p>è¯·æŒ‰è¦æ±‚ä½¿ç”¨MPIé›†åˆé€šä¿¡ï¼šå…·ä½“è¦æ±‚è§è¯¾ä»¶ã€‚</p>

<h3 id="psrsc">psrs.c</h3>

<p>è¿™é‡Œé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼ŒMPIæ•°æ®ç±»å‹é€‰æ‹©<code class="highlighter-rouge">MPI_LONG_INT</code>æ—¶å‘ç°ä¼ è¿‡æ¥çš„æ•°æ®å¤§å°åªæœ‰4ä¸ªå­—èŠ‚ï¼Ÿäºæ˜¯ä½¿ç”¨<code class="highlighter-rouge">MPI_BYTE</code>ç±»å‹ï¼Œè€Œå°†æˆ‘ä»¬çš„æ•°æ®æŒ‰ç…§æ¯”ç‰¹é‡æ–°è®¡ç®—å¤§å°å¹¶ä¼ è¾“ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//#define WK_GEN_DATA</span>
<span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;mpi.h&gt;
</span><span class="k">typedef</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">ll</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">sgn</span><span class="p">(</span><span class="n">ll</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">a</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">cmpll</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">sgn</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ll</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span> <span class="o">-</span> <span class="o">*</span><span class="p">(</span><span class="n">ll</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">);</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">numThreads</span><span class="p">;</span>
	<span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
	<span class="kt">double</span> <span class="n">start</span> <span class="o">=</span> <span class="n">MPI_Wtime</span><span class="p">();</span>
	<span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">numThreads</span><span class="p">);</span>
<span class="cp">#ifdef WK_GEN_DATA
</span>	<span class="n">ll</span> <span class="n">n</span> <span class="o">=</span> <span class="p">((</span><span class="n">ll</span><span class="p">)</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
	   <span class="n">len</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">numThreads</span><span class="p">,</span>
	   <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">ll</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">));</span>
<span class="cp">#else
</span>	<span class="n">ll</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">MPI_File</span> <span class="n">fh</span><span class="p">;</span>
	<span class="n">MPI_File_open</span><span class="p">(</span>
		<span class="n">MPI_COMM_WORLD</span><span class="p">,</span>
		<span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		<span class="n">MPI_MODE_RDONLY</span><span class="p">,</span>
		<span class="n">MPI_INFO_NULL</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">fh</span><span class="p">);</span>
	<span class="n">MPI_File_read_at_all</span><span class="p">(</span>
		<span class="n">fh</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">n</span><span class="p">,</span>
		<span class="mi">1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">),</span> <span class="c1">//1,</span>
		<span class="n">MPI_BYTE</span><span class="p">,</span>		<span class="c1">//MPI_LONG_INT,</span>
		<span class="n">MPI_STATUSES_IGNORE</span><span class="p">);</span>
	<span class="n">ll</span> <span class="n">blockSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">numThreads</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">numThreads</span><span class="p">,</span>
	   <span class="n">beg</span> <span class="o">=</span> <span class="n">id</span> <span class="o">*</span> <span class="n">blockSize</span><span class="p">,</span>
	   <span class="n">end</span> <span class="o">=</span> <span class="n">beg</span> <span class="o">+</span> <span class="n">blockSize</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">?</span> <span class="n">beg</span> <span class="o">+</span> <span class="n">blockSize</span> <span class="o">:</span> <span class="n">n</span><span class="p">,</span>
	   <span class="n">len</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">beg</span><span class="p">,</span>
	   <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">ll</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">));</span>
	<span class="n">MPI_File_read_at_all</span><span class="p">(</span>
		<span class="n">fh</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">beg</span><span class="p">),</span>
		<span class="n">a</span><span class="p">,</span>
		<span class="n">len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">),</span> <span class="c1">//len,</span>
		<span class="n">MPI_BYTE</span><span class="p">,</span>		  <span class="c1">//MPI_LONG_INT,</span>
		<span class="n">MPI_STATUSES_IGNORE</span><span class="p">);</span>
	<span class="n">MPI_File_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="p">);</span>
	<span class="n">MPI_Barrier</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Finish reading %ld datas at %fs with %d procs.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">MPI_Wtime</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">numThreads</span><span class="p">);</span>
<span class="cp">#endif
</span>	<span class="n">qsort</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">),</span> <span class="n">cmpll</span><span class="p">);</span>
	<span class="c1">//å±€éƒ¨æ’åº</span>
	<span class="n">ll</span> <span class="o">*</span><span class="n">sample</span> <span class="o">=</span> <span class="p">(</span><span class="n">ll</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">numThreads</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">)),</span>
	   <span class="o">*</span><span class="n">sampleGather</span> <span class="o">=</span> <span class="p">(</span><span class="n">ll</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">numThreads</span> <span class="o">*</span> <span class="n">numThreads</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numThreads</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">sample</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">len</span> <span class="o">/</span> <span class="n">numThreads</span> <span class="o">*</span> <span class="n">i</span><span class="p">];</span>

	<span class="c1">//é‡‡æ ·</span>
	<span class="n">MPI_Gather</span><span class="p">(</span>
		<span class="n">sample</span><span class="p">,</span>
		<span class="n">numThreads</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">),</span> <span class="c1">//numThreads,</span>
		<span class="n">MPI_BYTE</span><span class="p">,</span>				 <span class="c1">//MPI_LONG_INT,</span>
		<span class="n">sampleGather</span><span class="p">,</span>
		<span class="n">numThreads</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">),</span> <span class="c1">//numThreads,</span>
		<span class="n">MPI_BYTE</span><span class="p">,</span>				 <span class="c1">//MPI_LONG_INT,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">MPI_COMM_WORLD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">qsort</span><span class="p">(</span><span class="n">sampleGather</span><span class="p">,</span> <span class="n">numThreads</span> <span class="o">*</span> <span class="n">numThreads</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">),</span> <span class="n">cmpll</span><span class="p">);</span> <span class="c1">//å¯ä¼˜åŒ–ä¸ºnè·¯å½’å¹¶</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numThreads</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">sample</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampleGather</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">numThreads</span><span class="p">];</span> <span class="c1">//è·å¾—ä¸»å…ƒ</span>
<span class="cp">#ifndef WK_GEN_DATA
</span>		<span class="n">printf</span><span class="p">(</span><span class="s">"Get privot at %fs with %d procs.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">MPI_Wtime</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">numThreads</span><span class="p">);</span>
<span class="cp">#endif
</span>	<span class="p">}</span>

	<span class="n">MPI_Bcast</span><span class="p">(</span>
		<span class="n">sample</span><span class="p">,</span>
		<span class="n">numThreads</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">),</span> <span class="c1">//numThreads,</span>
		<span class="n">MPI_BYTE</span><span class="p">,</span>				 <span class="c1">//MPI_LONG_INT,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">MPI_COMM_WORLD</span><span class="p">);</span> <span class="c1">//åˆ†å‘ä¸»å…ƒ</span>

	<span class="kt">int</span> <span class="o">*</span><span class="n">sendCounts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">numThreads</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)),</span>
		<span class="o">*</span><span class="n">recvCounts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">numThreads</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)),</span>
		<span class="o">*</span><span class="n">sdisp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">numThreads</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)),</span>
		<span class="o">*</span><span class="n">rdisp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">numThreads</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numThreads</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">sendCounts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">numThreads</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">sample</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
			<span class="o">++</span><span class="n">j</span><span class="p">;</span>
		<span class="c1">//++sendCounts[j - 1];</span>
		<span class="n">sendCounts</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">MPI_Alltoall</span><span class="p">(</span> <span class="c1">//æå‰é€šçŸ¥ä¸€ä¸‹èŠ‚ç‚¹ï¼Œå„ä¸ªèŠ‚ç‚¹è¦å‡†å¤‡æ¥æ”¶å¤šå°‘æ•°æ®</span>
		<span class="n">sendCounts</span><span class="p">,</span>
		<span class="c1">//1 * sizeof(int),</span>
		<span class="mi">1</span><span class="p">,</span>
		<span class="c1">//MPI_BYTE,</span>
		<span class="n">MPI_INT</span><span class="p">,</span>
		<span class="n">recvCounts</span><span class="p">,</span>
		<span class="c1">//1 * sizeof(int),</span>
		<span class="mi">1</span><span class="p">,</span>
		<span class="c1">//MPI_BYTE,</span>
		<span class="n">MPI_INT</span><span class="p">,</span>
		<span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="cp">#ifndef WK_GEN_DATA
</span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Send counts at %fs with %d procs.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">MPI_Wtime</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">numThreads</span><span class="p">);</span>
<span class="cp">#endif
</span>	<span class="n">sdisp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdisp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numThreads</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">sdisp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sendCounts</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">sdisp</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">rdisp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">recvCounts</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rdisp</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="c1">//ll *local = (ll *)malloc((rdisp[numThreads - 1] + recvCounts[numThreads - 1]) * sizeof(ll));</span>
	<span class="n">ll</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="n">ll</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">rdisp</span><span class="p">[</span><span class="n">numThreads</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">recvCounts</span><span class="p">[</span><span class="n">numThreads</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>

	<span class="n">MPI_Alltoallv</span><span class="p">(</span>
		<span class="n">a</span><span class="p">,</span>
		<span class="n">sendCounts</span><span class="p">,</span>
		<span class="n">sdisp</span><span class="p">,</span>
		<span class="n">MPI_BYTE</span><span class="p">,</span> <span class="c1">//MPI_LONG_INT,</span>
		<span class="n">local</span><span class="p">,</span>
		<span class="n">recvCounts</span><span class="p">,</span>
		<span class="n">rdisp</span><span class="p">,</span>
		<span class="n">MPI_BYTE</span><span class="p">,</span> <span class="c1">//MPI_LONG_INT,</span>
		<span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="cp">#ifndef WK_GEN_DATA
</span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Alltoallv at %fs with %d procs.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">MPI_Wtime</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">numThreads</span><span class="p">);</span>
<span class="cp">#endif
</span>	<span class="c1">//qsort(local, rdisp[numThreads - 1] + recvCounts[numThreads - 1], sizeof(ll), cmpll); //å¯ä¼˜åŒ–ä¸ºnè·¯å½’å¹¶</span>
	<span class="n">qsort</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="p">(</span><span class="n">rdisp</span><span class="p">[</span><span class="n">numThreads</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">recvCounts</span><span class="p">[</span><span class="n">numThreads</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ll</span><span class="p">),</span> <span class="n">cmpll</span><span class="p">);</span> <span class="c1">//å¯ä¼˜åŒ–ä¸ºnè·¯å½’å¹¶</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"Finish sort %ld elements at %fs with %d procs.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">MPI_Wtime</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">numThreads</span><span class="p">);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">sendCounts</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">recvCounts</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">sdisp</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">rdisp</span><span class="p">);</span>

	<span class="n">free</span><span class="p">(</span><span class="n">sample</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">sampleGather</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

	<span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="psrspbs">psrs.pbs</h3>

<p>ä½œä¸šè°ƒåº¦è„šæœ¬ï¼Œç›´æ¥ä½¿ç”¨èƒ½å¤Ÿè·å¾—çš„æœ€å¤§è®¡ç®—èµ„æºï¼ˆ512æ ¸ï¼‰è¿›è¡Œè®¡ç®—ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#PBS -N psrs</span>
<span class="c">#PBS -l nodes=16:ppn=32</span>
<span class="c">#PBS -j oe</span>

<span class="nb">source</span> /public/software/profile.d/mpi_openmpi-intel-2.1.2.sh
mpicc psrs.c <span class="nt">-o</span> psrs <span class="nt">-std</span><span class="o">=</span>c11
mpiexec <span class="nt">-machinefile</span> <span class="nv">$PBS_NODEFILE</span> ./psrs /public/home/shared_dir/psrs_data
</code></pre></div></div>

<h3 id="psrso1529">psrs.o1529</h3>

<p>ä½œä¸šè„šæœ¬å¾—åˆ°çš„è¾“å‡ºæ–‡ä»¶ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä¸€å…±ä½¿ç”¨äº†<code class="highlighter-rouge">18.124634s</code>å°±æˆåŠŸå¯¹<code class="highlighter-rouge">4294967295</code>ä¸ªæ•°è¿›è¡Œäº†æ’åºï¼Œå…¶ä¸­æœ‰<code class="highlighter-rouge">6.403623s</code>èŠ±è´¹åœ¨æ–‡ä»¶è¯»å…¥ä¸Šï¼Œä¹Ÿå°±æ˜¯æ€»å…±èŠ±äº†ä¸åˆ°åäºŒç§’å°±å®Œæˆäº†æ’åºï¼Œè¿˜æ˜¯æ˜æ˜¾ä¼˜äºå•æœºä¸²è¡Œæ’åºçš„ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Finish reading 4294967295 datas at 6.403623s with 512 procs.
Get privot at 8.314104s with 512 procs.
Send counts at 8.333872s with 512 procs.
Alltoallv at 17.238057s with 512 procs.
Finish all the works at 18.124634s with 512 procs.
</code></pre></div></div>

<h3 id="å¡«è¡¨-1">å¡«è¡¨</h3>

<p>å»æ‰<code class="highlighter-rouge">#define WK_GEN_DATA</code>å‰çš„æ³¨é‡Šï¼Œè¿›è¡Œæµ‹è¯•ï¼ˆä¸å†ä»è¾“å…¥æ–‡ä»¶ä¸­å¾—åˆ°æ•°æ®ï¼Œå„è¿›ç¨‹éšæœºç”ŸæˆæŒ‡å®šé—®é¢˜è§„æ¨¡è§„æ¨¡çš„æ•°æ®ï¼‰ã€‚</p>

<p>æ­¤å¤–ï¼Œç”±äºå¹¶è¡Œæ­£åˆ™é‡‡æ ·æ’åºçš„é™åˆ¶ï¼Œæ’åºå…ƒç´ çš„æ•°é‡è‡³å°‘è¦æ˜¯è¿›ç¨‹æ•°çš„å¹³æ–¹å€ã€‚å› æ­¤è¿™é‡Œé—®é¢˜è§„æ¨¡ä»$2^18$å¼€å§‹ï¼ˆè¿›ç¨‹æ•°æœ€å¤šæœ‰$512=2^9$ä¸ªï¼‰ã€‚</p>

<p>ç”±äºæ•°æ®è§„æ¨¡è¿‡å¤§ï¼Œè¿›ç¨‹æ•°å°‘çš„æ—¶å€™è¿è¡Œæ—¶é—´è¶…è¿‡ä¸€å°æ—¶è¢«è°ƒåº¦å™¨<code class="highlighter-rouge">kill</code>äº†ï¼Œå› æ­¤å¯¹åº”æ•°æ®æ²¡æœ‰æµ‹å‡ºè¿è¡Œæ—¶é—´å’Œç›¸åº”åŠ é€Ÿæ¯”ã€‚</p>

<h4 id="è¿è¡Œæ—¶é—´tå•ä½s-1">è¿è¡Œæ—¶é—´Tï¼ˆå•ä½sï¼‰</h4>

<p>è¯¦è§ä¸‹é¢çš„è¾“å‡ºæ–‡ä»¶éƒ¨åˆ†ã€‚</p>

<table>
  <thead>
    <tr>
      <th>è¿›ç¨‹æ•°\é—®é¢˜è§„æ¨¡</th>
      <th>$2^{18}$</th>
      <th>$2^{22}$</th>
      <th>$2^{26}$</th>
      <th>$2^{30}$</th>
      <th>$2^{31}$</th>
      <th>$2^{32}$</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>0.04</td>
      <td>0.35</td>
      <td>7.10</td>
      <td>936.30</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.04</td>
      <td>0.23</td>
      <td>3.10</td>
      <td>463.53</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.05</td>
      <td>0.20</td>
      <td>2.12</td>
      <td>229.26</td>
      <td>890.62</td>
      <td>x</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.05</td>
      <td>0.18</td>
      <td>1.56</td>
      <td>149.69</td>
      <td>592.83</td>
      <td>x</td>
    </tr>
    <tr>
      <td>16</td>
      <td>0.05</td>
      <td>0.20</td>
      <td>1.22</td>
      <td>80.37</td>
      <td>250.98</td>
      <td>490.23</td>
    </tr>
    <tr>
      <td>32</td>
      <td>0.09</td>
      <td>0.22</td>
      <td>0.96</td>
      <td>43.30</td>
      <td>176.67</td>
      <td>277.68</td>
    </tr>
    <tr>
      <td>64</td>
      <td>0.14</td>
      <td>0.47</td>
      <td>0.89</td>
      <td>21.77</td>
      <td>136.30</td>
      <td>90.79</td>
    </tr>
    <tr>
      <td>128</td>
      <td>0.21</td>
      <td>0.44</td>
      <td>1.13</td>
      <td>17.87</td>
      <td>33.21</td>
      <td>44.52</td>
    </tr>
    <tr>
      <td>256</td>
      <td>0.29</td>
      <td>0.45</td>
      <td>1.28</td>
      <td>9.22</td>
      <td>17.43</td>
      <td>23.93</td>
    </tr>
    <tr>
      <td>512</td>
      <td>0.38</td>
      <td>0.57</td>
      <td>1.47</td>
      <td>5.10</td>
      <td>8.30</td>
      <td>14.47</td>
    </tr>
  </tbody>
</table>

<h4 id="åŠ é€Ÿæ¯”s-1">åŠ é€Ÿæ¯”S</h4>

<p>åŠ é€Ÿæ¯”S=åŒç­‰è§„æ¨¡ä¸‹çš„ä¸²è¡Œæ—¶é—´/å¹¶è¡Œæ—¶é—´ã€‚</p>

<table>
  <thead>
    <tr>
      <th>è¿›ç¨‹æ•°\é—®é¢˜è§„æ¨¡</th>
      <th>$2^{18}$</th>
      <th>$2^{22}$</th>
      <th>$2^{26}$</th>
      <th>$2^{30}$</th>
      <th>$2^{31}$</th>
      <th>$2^{32}$</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>1.00</td>
      <td>0.35</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1.00</td>
      <td>1.52</td>
      <td>2.29</td>
      <td>2.02</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.80</td>
      <td>1.75</td>
      <td>3.35</td>
      <td>4.08</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.80</td>
      <td>1.94</td>
      <td>4.55</td>
      <td>6.25</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>16</td>
      <td>0.80</td>
      <td>1.75</td>
      <td>5.81</td>
      <td>11.65</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>32</td>
      <td>0.44</td>
      <td>1.59</td>
      <td>7.40</td>
      <td>21.62</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>64</td>
      <td>0.29</td>
      <td>0.74</td>
      <td>7.98</td>
      <td>43.00</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>128</td>
      <td>0.19</td>
      <td>0.80</td>
      <td>6.28</td>
      <td>52.40</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>256</td>
      <td>0.14</td>
      <td>0.78</td>
      <td>5.55</td>
      <td>101.55</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>512</td>
      <td>0.11</td>
      <td>0.61</td>
      <td>4.83</td>
      <td>183.58</td>
      <td>x</td>
      <td>x</td>
    </tr>
  </tbody>
</table>

<h4 id="æ•ˆç‡e-1">æ•ˆç‡E</h4>

<p>è¿è¡Œæ•ˆç‡E=åŠ é€Ÿæ¯”S/å¹¶è¡Œçº¿ç¨‹æ•°ã€‚</p>

<table>
  <thead>
    <tr>
      <th>è¿›ç¨‹æ•°\é—®é¢˜è§„æ¨¡</th>
      <th>$2^{18}$</th>
      <th>$2^{22}$</th>
      <th>$2^{26}$</th>
      <th>$2^{30}$</th>
      <th>$2^{31}$</th>
      <th>$2^{32}$</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>1.00</td>
      <td>0.35</td>
      <td>1.00</td>
      <td>1.00</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1.00</td>
      <td>0.76</td>
      <td>1.15</td>
      <td>1.01</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.20</td>
      <td>0.44</td>
      <td>0.84</td>
      <td>1.02</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.10</td>
      <td>0.24</td>
      <td>0.57</td>
      <td>0.78</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>16</td>
      <td>0.05</td>
      <td>0.11</td>
      <td>0.32</td>
      <td>0.73</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>32</td>
      <td>0.01</td>
      <td>0.05</td>
      <td>0.23</td>
      <td>0.66</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>64</td>
      <td>0.005</td>
      <td>0.01</td>
      <td>0.12</td>
      <td>0.67</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>128</td>
      <td>0.001</td>
      <td>0.006</td>
      <td>0.05</td>
      <td>0.41</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>256</td>
      <td>0.0005</td>
      <td>0.003</td>
      <td>0.02</td>
      <td>0.40</td>
      <td>x</td>
      <td>x</td>
    </tr>
    <tr>
      <td>512</td>
      <td>0.0002</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>0.36</td>
      <td>x</td>
      <td>x</td>
    </tr>
  </tbody>
</table>
:ET